## 1. æ¦‚è§ˆ

![alt text](../image/Javaå¹¶å‘ç¼–ç¨‹/image.png)

## 2. è¿›ç¨‹ & çº¿ç¨‹

è¿›ç¨‹ & çº¿ç¨‹çš„æ¦‚å¿µ
å¹¶è¡Œ & å¹¶å‘çš„æ¦‚å¿µ
çº¿ç¨‹åŸºæœ¬åº”ç”¨

### 2.1. è¿›ç¨‹ & çº¿ç¨‹

è¿›ç¨‹ï¼ˆProcessï¼‰ï¼šæ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ­£åœ¨è¢«æ‰§è¡Œçš„ç¨‹åºçš„å®ä¾‹

- è¿›ç¨‹æ˜¯ç”¨æ¥åœ¨æ‰§è¡Œç¨‹åºçš„æ—¶å€™åŠ è½½æŒ‡ä»¤ï¼Œç®¡ç†æ•°æ®ï¼Œç®¡ç†IOçš„
- çº¿ç¨‹ï¼ˆThreadï¼‰ï¼šæ“ä½œç³»ç»Ÿæœ€å°çš„è°ƒåº¦å•ä½ï¼Œæ˜¯è¿›ç¨‹å†…çš„æ‰§è¡Œå•å…ƒ
- ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUå»æ‰§è¡Œ

äºŒè€…å¯¹æ¯”ï¼š

ç‰¹æ€§ | è¿›ç¨‹ | çº¿ç¨‹
---------|----------|---------
èµ„æºåˆ†é… | ç‹¬ç«‹çš„å†…å­˜ã€æ–‡ä»¶ã€CPU æ—¶é—´ç­‰|å…±äº«è¿›ç¨‹çš„èµ„æºï¼ˆå†…å­˜ã€æ–‡ä»¶ç­‰ï¼‰
ç‹¬ç«‹æ€§|é«˜åº¦éš”ç¦»ï¼Œå´©æºƒä¸å½±å“å…¶ä»–è¿›ç¨‹|å…±äº«å†…å­˜ï¼Œçº¿ç¨‹å´©æºƒå¯èƒ½å¯¼è‡´æ•´ä¸ªè¿›ç¨‹å´©æºƒ
é€šä¿¡æ–¹å¼ |éœ€è¦è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ï¼Œå¦‚ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰|ç›´æ¥è¯»å†™å…±äº«å†…å­˜ï¼ˆéœ€åŠ é”åŒæ­¥ï¼‰
åˆ›å»º/é”€æ¯å¼€é”€|é«˜ï¼ˆéœ€è¦åˆ†é…ç‹¬ç«‹èµ„æºï¼‰|ä½ï¼ˆå¤ç”¨è¿›ç¨‹èµ„æºï¼‰
åˆ‡æ¢å¼€é”€|é«˜ï¼ˆéœ€åˆ‡æ¢å†…å­˜ç©ºé—´ã€å¯„å­˜å™¨ç­‰ï¼‰|ä½ï¼ˆä»…åˆ‡æ¢å¯„å­˜å™¨ã€æ ˆç­‰ï¼‰
åº”ç”¨åœºæ™¯|éœ€è¦éš”ç¦»çš„ç‹¬ç«‹ä»»åŠ¡ï¼ˆå¦‚æµè§ˆå™¨å¤šæ ‡ç­¾é¡µï¼‰|éœ€è¦é«˜æ•ˆåä½œçš„ä»»åŠ¡ï¼ˆå¦‚å¹¶å‘è®¡ç®—ã€å®æ—¶å“åº”ï¼‰

### 2.2. å¹¶è¡Œ & å¹¶å‘

å¹¶å‘ï¼ˆConcurrentï¼‰ï¼šçº¿ç¨‹è½®æµä½¿ç”¨CPUçš„åšæ³•ï¼ˆå½“CPUæ˜¯å•æ ¸æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¸­çš„ä»»åŠ¡è°ƒåº¦å™¨ç»„ä»¶ä¼šä¸²è¡Œçš„å°†CPUçš„æ—¶é—´ç‰‡åˆ†ç»™ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨ï¼Œç”±äºCPUçš„æ—¶é—´ç‰‡éå¸¸çŸ­åªæœ‰15æ¯«ç§’ï¼Œè®©äººæ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ï¼‰æ“ä½œç³»ç»Ÿé€šè¿‡æ—¶é—´ç‰‡è½®è½¬ï¼ˆå¦‚æ¯ 10ms åˆ‡æ¢ä¸€æ¬¡çº¿ç¨‹ï¼‰æ¨¡æ‹Ÿâ€œåŒæ—¶è¿è¡Œâ€çš„æ•ˆæœ

å¹¶è¡Œï¼ˆParallelï¼‰ï¼šå½“CPUæœ‰å¤šæ ¸æ—¶ï¼Œå°±å¯ä»¥å¤šä¸ªæ ¸åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œä½†å½“çº¿ç¨‹æ•°å¤šäºæ ¸æ•°æ—¶ï¼Œå°±å¹¶è¡Œå’Œå¹¶å‘åŒæ—¶è¿›è¡Œ

### 2.3. ğŸåº”ç”¨

#### 2.3.1. å¼‚æ­¥è°ƒç”¨

å¼‚æ­¥ & åŒæ­¥ï¼šåŒæ­¥éœ€è¦ç­‰å¾…ç»“æœè¿”å›æ‰èƒ½ç»§ç»­è¿è¡Œï¼Œå¼‚æ­¥ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›å°±å¯ä»¥è¿è¡Œ

è¿ç”¨åœºæ™¯ï¼š

- é«˜å¹¶å‘è¯·æ±‚ï¼ˆåœ¨åŒä¸€æ—¶é—´ç‚¹æˆ–çŸ­æ—¶é—´å†…ï¼Œç³»ç»Ÿæ¥æ”¶åˆ°å¤§é‡çš„è¯·æ±‚ï¼‰
  - å¦‚æœæ¯ä¸ªè¯·æ±‚éƒ½åŒæ­¥å¤„ç†ï¼ˆç­‰å¾…ä¸€ä¸ªå¤„ç†å®Œå†å¤„ç†ä¸‹ä¸€ä¸ªï¼‰ï¼ŒæœåŠ¡å™¨ä¼šè¢«å¡æ­»ï¼Œæ— æ³•å“åº”æ–°çš„è¯·æ±‚
  - å¼‚æ­¥å¤„ç†ï¼šå½“æŸä¸ªè¯·æ±‚éœ€è¦è¯·æ±‚æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨ä¸ä¼šç­‰å¾…è€Œæ˜¯ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚ï¼Œç›´åˆ°æ•°æ®åº“è¿”å›ç»“æœå†è¿”å›ç»™å®¢æˆ·ç«¯
- ç”¨æˆ·ç•Œé¢ï¼ˆUIï¼‰çš„å“åº”
  - æ¯”å¦‚ä¸€ä¸ªè§†é¢‘æ ¼å¼è½¬æ¢è½¯ä»¶ï¼Œè½¬æ¢ä¸€ä¸ªè§†é¢‘è¦å¾ˆä¹…ï¼Œå¦‚æœåŒæ­¥åœ¨è§†é¢‘è½¬æ¢æœŸé—´ï¼Œç•Œé¢ä¼šå¡æ­»ï¼Œç”¨æˆ·æ— æ³•è¿›è¡Œå…¶ä»–æ“ä½œ
  - å¼‚æ­¥å¤„ç†å¯ä»¥åœ¨åå°çº¿ç¨‹å¼‚æ­¥è½¬æ¢æ–‡ä»¶ï¼Œä¸»çº¿ç¨‹å¯ä»¥ä¿æŒç•Œé¢äº¤äº’ï¼Œè¯»å–å®Œæˆåæ›´æ–°UI
- å®æ—¶èŠå¤©åº”ç”¨
  - å¦‚æœåŒæ­¥å¤„ç†ï¼Œåœ¨ç”¨æˆ·è¾“å…¥æ¶ˆæ¯æ—¶ï¼Œç³»ç»Ÿéœ€è¦ç›‘å¬ï¼Œå°±æ— æ³•æ”¶åˆ°æ–°æ¶ˆæ¯
  - å¼‚æ­¥äº‹ä»¶ç›‘å¬ï¼Œç”¨æˆ·è¾“å…¥å’Œæ¥æ”¶æ¶ˆæ¯äº’ä¸é˜»å¡

#### 2.3.2. æé«˜æ•ˆç‡

åˆ©ç”¨å¤šæ ¸CPUçš„ä¼˜åŠ¿ï¼Œå¹¶è¡Œè®¡ç®—ï¼Œæé«˜æ•ˆç‡ï¼ˆå¤šæ ¸æ‰èƒ½æé«˜æ•ˆç‡ï¼Œå•æ ¸ä¾ç„¶æ˜¯ä¸²è¡Œï¼‰

- å•æ ¸CPUï¼‹å¤šçº¿ç¨‹ï¼šä¸èƒ½æé«˜æ•ˆç‡ï¼Œå•æ ¸ä¸‹å¤šçº¿ç¨‹çš„æ ¸å¿ƒæ˜¯ä»»åŠ¡è°ƒåº¦ï¼Œé˜²æ­¢æŸä¸ªè€—æ—¶çº¿ç¨‹ç‹¬å CPUï¼Œå¯¼è‡´å…¶ä»–ä»»åŠ¡æ— æ³•æ‰§è¡Œ
- å¤šæ ¸CPUï¼‹å¤šçº¿ç¨‹ï¼šèƒ½å¦æé«˜æ•ˆç‡å–å†³äºä»»åŠ¡è®¾è®¡ï¼Œå–å†³äºä»»åŠ¡æ˜¯å¦å¯æ‹†åˆ†ï¼Œä»¥åŠæ‹†åˆ†åçš„ä¼˜åŒ–ç©ºé—´ï¼ˆå‚è€ƒé˜¿å§†è¾¾å°”å®šå¾‹ï¼‰
- IOæ“ä½œï¼šIO æ“ä½œï¼ˆå¦‚è¯»å†™æ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚ï¼‰æœ¬èº«ä¸å ç”¨ CPUï¼Œä½†ä¼ ç»Ÿçš„é˜»å¡ IO ä¼šå¯¼è‡´çº¿ç¨‹ç­‰å¾…ï¼Œæµªè´¹èµ„æºã€‚éé˜»å¡ IO å’Œå¼‚æ­¥ IO é€šè¿‡é¿å…ç­‰å¾…æ¥æå‡æ•ˆç‡ã€‚

## 3. Java çº¿ç¨‹

### 3.1. åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹

ç¨‹åºè¿è¡Œæ—¶è‡ªåŠ¨æœ‰ä¸»çº¿ç¨‹è¢«åˆ›å»ºï¼Œå¦‚æœè¿˜è¦åˆ›å»ºå•ç‹¬çš„çº¿ç¨‹ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•

#### 3.1.1. ç›´æ¥ä½¿ç”¨Thread

**åˆ›å»º** å’Œ **å¯åŠ¨** åˆ†ä¸ºä¸¤æ­¥

```java
// åˆ›å»ºçº¿ç¨‹å¯¹è±¡ 
Thread t = new Thread() {
// ä¹Ÿå¯ä»¥åœ¨æ„é€ æ–¹æ³•ä¸­æ·»åŠ å‚æ•°ç›´æ¥èµ·åå­—
//  Thread t = new Thread("t1")
    public void run() {  
        // è¦æ‰§è¡Œçš„ä»»åŠ¡     
    }  
};  

// ç»™çº¿ç¨‹èµ·åå­—
t.setName("t1");

// å¯åŠ¨çº¿ç¨‹ 
t.start();
```

#### 3.1.2. ä½¿ç”¨ Runnable é…åˆ Thread

æŠŠã€çº¿ç¨‹ã€‘å’Œã€ä»»åŠ¡ã€‘ï¼ˆè¦æ‰§è¡Œçš„ä»£ç ï¼‰åˆ†å¼€

Runnable æ˜¯ Java ä¸­çš„ä¸€ä¸ªæ¥å£ï¼ŒåªåŒ…å«ä¸€ä¸ªæ–¹æ³•ï¼š

```java
public interface Runnable {
    void run(); // å®šä¹‰çº¿ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡
}
```

å®ƒè¡¨ç¤ºä¸€æ®µå¯ä»¥è¢«çº¿ç¨‹æ‰§è¡Œçš„ä»£ç é€»è¾‘ï¼ˆå³ä»»åŠ¡ï¼‰ï¼Œä½†æœ¬èº«å¹¶ä¸æ˜¯çº¿ç¨‹ã€‚

ä¸ºä»€ä¹ˆéœ€è¦ Runnableï¼Ÿ

- è§£è€¦ä»»åŠ¡ä¸çº¿ç¨‹ï¼šå°†ä»»åŠ¡ï¼ˆRunnableï¼‰å’Œçº¿ç¨‹ï¼ˆThreadï¼‰åˆ†ç¦»ï¼Œç¬¦åˆé¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™ï¼ˆå•ä¸€èŒè´£ï¼‰ã€‚
- é¿å…å•ç»§æ‰¿é™åˆ¶ï¼šJava æ˜¯å•ç»§æ‰¿è¯­è¨€ï¼Œå¦‚æœç±»å·²ç»ç»§æ‰¿äº†å…¶ä»–ç±»ï¼Œå°±æ— æ³•å†ç»§æ‰¿ Thread ç±»ï¼Œä½†å¯ä»¥å®ç° Runnable æ¥å£ã€‚
- èµ„æºå…±äº«ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ª Runnable å®ä¾‹ï¼ˆé€‚åˆå¤„ç†å…±äº«èµ„æºçš„åœºæ™¯ï¼‰ã€‚

æ–¹å¼

- Thread ä»£è¡¨çº¿ç¨‹
- Runnable å¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆçº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ï¼‰

```java
// åˆ›å»ºä»»åŠ¡å¯¹è±¡ 
Runnable task2 = new Runnable() {  
    @Override  
    public void run() {  
        log.debug("hello");     
    }  
};  

// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è 
Thread t2 = new Thread(task2, "t2");  

t2.start();
```

lambda ç²¾ç®€ä»£ç 

```java
// åˆ›å»ºä»»åŠ¡å¯¹è±¡ 
Runnable task2 = () -> log.debug("hello");  

// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è 
Thread t2 = new Thread(task2, "t2");  
t2.start();
```

è¿˜å¯ä»¥æ›´ç²¾ç®€

```java
Thread t2 = new Thread(() -> log.debug("hello"), "t2");  
t2.start();
```

åŸç† - ä¸¤ç§æ–¹æ³•å¯¹æ¯”

- ä¸¤ç§æ–¹æ³•å®é™…ä¸Šè°ƒç”¨çš„éƒ½æ˜¯çº¿ç¨‹Threadç±»ä¸­çš„runæ–¹æ³•
- æ–¹æ³•1 æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œæ–¹æ³•2 æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº† 
- ç”¨ Runnable æ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§ API é…åˆ 
- ç”¨ Runnable è®©ä»»åŠ¡ç±»è„±ç¦»äº† Thread ç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»

#### 3.1.3. FutureTask é…åˆ Thread

FutureTask èƒ½å¤Ÿæ¥æ”¶ Callable ç±»å‹çš„å‚æ•°ï¼Œç”¨æ¥å¤„ç†æœ‰è¿”å›ç»“æœçš„æƒ…å†µ

> - Callable å’Œ FutureTask æ˜¯ Java å¤šçº¿ç¨‹ä¸­å¤„ç†å¼‚æ­¥ä»»åŠ¡å¹¶è·å–ç»“æœçš„æ ¸å¿ƒç±»ï¼Œè§£å†³äº†ä¼ ç»Ÿ Runnable æ— æ³•è¿”å›ç»“æœå’ŒæŠ›å‡ºå¼‚å¸¸çš„ç—›ç‚¹
>   - Runnable çš„ run() æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œä¹Ÿæ— æ³•æŠ›å‡ºå¼‚å¸¸
>   - Callable æ¥å£çš„ call() æ–¹æ³•å¯ä»¥è¿”å›ç»“æœï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸

- FutureTask æ˜¯ Runnable å’Œ Future çš„ç»“åˆä½“ï¼šï¼ˆç»§æ‰¿Runnable å’Œ Futureï¼‰
  - åŒ…è£… Callable ä»»åŠ¡ï¼Œäº¤ç»™çº¿ç¨‹æ‰§è¡Œï¼ˆRunnable çš„åŠŸèƒ½ï¼‰ã€‚
  - æä¾›æ–¹æ³•æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ã€å–æ¶ˆä»»åŠ¡ã€è·å–ç»“æœï¼ˆFuture çš„åŠŸèƒ½ï¼‰ã€‚

```java
// åˆ›å»ºä»»åŠ¡å¯¹è±¡ 
FutureTask task3 = new FutureTask<>(() -> {  
    log.debug("hello");  
    return 100;  
});  

// å‚æ•°1 æ˜¯ä»»åŠ¡å¯¹è±¡; å‚æ•°2 æ˜¯çº¿ç¨‹åå­—ï¼Œæ¨è 
new Thread(task3, "t3").start();  

// ä¸»çº¿ç¨‹é˜»å¡ï¼ŒåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœ 
Integer result = task3.get();  
log.debug("ç»“æœæ˜¯:{}", result);
```
### 3.2. è§‚å¯Ÿå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ

- äº¤æ›¿æ‰§è¡Œ
- è°å…ˆè°åï¼Œä¸ç”±æˆ‘ä»¬æ§åˆ¶

```java
@Slf4j(topic = "c.TestMultiThread")
public class TestMultiThread {
    public static void main(String[] args) {
        new Thread(() -> {
            while (true) {
                log.debug("running...");
            }
        } "t1").start();

        new Thread(() -> {
            while (true) {
                log.debug("running...");
            }
        } "t2").start();
    }
}
```

### 3.3. æŸ¥çœ‹è¿›çº¿ç¨‹çš„æ–¹æ³•

è¿›ç¨‹å·ï¼šPID

**Windows**

- ä»»åŠ¡ç®¡ç†å™¨æŸ¥çœ‹
- ï¼ˆå‘½ä»¤è¡Œï¼‰tasklist æŸ¥çœ‹è¿›ç¨‹
- ï¼ˆå‘½ä»¤è¡Œï¼‰taskkill å…³é—­è¿›ç¨‹

**Linux**

- `ps -ef (| grep <java>)` æŸ¥çœ‹è¿›ç¨‹ï¼ˆgrepç­›é€‰å…³é”®å­—ï¼‰
- `top` æŸ¥çœ‹è¿›ç¨‹ï¼ˆåŠ¨æ€ä¿¡æ¯ï¼‰
- `top -H -<pid>` æŸ¥çœ‹å­è¿›ç¨‹ï¼ˆHä»£è¡¨çº¿ç¨‹æ ‘ï¼Œpæ˜¯pidä»£è¡¨æŒ‡å®šè¿›ç¨‹ï¼‰
- `kill -<pid>` å…³é—­è¿›ç¨‹

**Java**

- `jps` æŸ¥çœ‹javaè¿›ç¨‹
- `jstack <pid>`  æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€
- `jconsole`  æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰

jconsole è¿œç¨‹ç›‘æ§é…ç½®
<!-- TODO -->

### 3.4. ğŸ¤”çº¿ç¨‹è¿è¡Œã€åŸç†ã€‘

#### 3.4.1. æ ˆä¸æ ˆå¸§

Java Virtual Machine Stacks ï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰

JVMç”±å †ã€æ ˆã€æ–¹æ³•åŒºç»„æˆï¼Œå…¶ä¸­æ ˆæ˜¯ç»™çº¿ç¨‹ç”¨çš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆã€‚

- æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜
- æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•

å †ä¸­å­˜æ”¾çš„æ˜¯å¯¹è±¡å®ä¾‹
æ–¹æ³•åŒºå­˜æ”¾æ–¹æ³•
æ ˆå¸§ä¸­å­˜æ”¾çš„æ˜¯å±€éƒ¨å˜é‡è¡¨ã€è¿”å›åœ°å€ã€é”è®°å½•å’Œæ“ä½œæ•°æ ˆ

##### 3.4.1.1. å•ä¸ªçº¿ç¨‹

```java
public class TestFrames {
    public static void main(String[] args) {
        method1(10);
    }

    private static void method1(int x) {
        int y = x + 1;
        Object m = method2();
        System.out.println(m);
    }

    private static Object method2() {
        Object n = new Object();
        return n;
    }
}
```

![alt text](../0.image/Javaå¹¶å‘ç¼–ç¨‹/image-1.png)

1. **çº¿ç¨‹å¯åŠ¨**ï¼šJVM ä¸ºçº¿ç¨‹åˆ†é…ç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆã€‚
2. **æ–¹æ³•è°ƒç”¨**ï¼šä»æ ˆé¡¶å‹å…¥ä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼ŒåŒ…å«ï¼š
   - **å±€éƒ¨å˜é‡è¡¨**ï¼ˆå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå±€éƒ¨å˜é‡ï¼‰
   * **æ“ä½œæ•°æ ˆ**ï¼ˆç”¨äºè®¡ç®—å’Œä¸´æ—¶å­˜å‚¨ï¼‰
   * **åŠ¨æ€é“¾æ¥**ï¼ˆæŒ‡å‘æ–¹æ³•åŒºçš„æ–¹æ³•ç¬¦å·å¼•ç”¨ï¼‰
   * **è¿”å›åœ°å€**ï¼ˆæ–¹æ³•ç»“æŸåçš„è·³è½¬ä½ç½®ï¼‰
3. **æ–¹æ³•æ‰§è¡Œ**ï¼š
   * æ“ä½œæ•°æ ˆç”¨äºç®—æœ¯è¿ç®—ã€æ–¹æ³•è°ƒç”¨å‚æ•°ä¼ é€’ç­‰ã€‚
   * å±€éƒ¨å˜é‡è¡¨ **é€šè¿‡å¼•ç”¨** è®¿é—®å †å†…å­˜ä¸­çš„å¯¹è±¡å®ä¾‹ã€‚
   * è‹¥ä½¿ç”¨synchronizedï¼Œé”è®°å½•ä¼šå…³è”åˆ°å¯¹è±¡çš„ Monitorã€‚
4. **æ–¹æ³•è¿”å›**ï¼š
   * æ ˆå¸§è¢«æ•´ä½“å¼¹å‡ºï¼Œç¨‹åºè®¡æ•°å™¨æ¢å¤åˆ°è°ƒç”¨è€…çš„ä½ç½®ã€‚
   * å †ä¸­çš„å¯¹è±¡å®ä¾‹ç”±åƒåœ¾å›æ”¶å™¨ç®¡ç†ï¼ˆä¸æ ˆå¸§é‡Šæ”¾æ— å…³ï¼‰ã€‚

> - **ç¨‹åºè®¡æ•°å™¨æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä½†å®ƒå¹¶ä¸å±äºæ ˆå†…å­˜çš„ä¸€éƒ¨åˆ†**ï¼Œè€Œæ˜¯ç‹¬ç«‹å­˜åœ¨çš„å¯„å­˜å™¨ï¼ˆJVM å†…å­˜æ¨¡å‹ä¸­çš„ä¸€éƒ¨åˆ†ï¼‰,å®ƒçš„ä½œç”¨æ˜¯è®°å½•å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€
> - å±€éƒ¨å˜é‡è¡¨å­˜å‚¨çš„æ˜¯**åŸºæœ¬æ•°æ®ç±»å‹**å’Œ**å¯¹è±¡å¼•ç”¨**ï¼ˆæŒ‡å‘å †å†…å­˜çš„æŒ‡é’ˆï¼‰ï¼Œå¯¹è±¡å®ä¾‹æœ¬èº«åœ¨å †ä¸­
> - é”è®°å½•å±äºæ ˆå¸§çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå®ç°`synchronized`å…³é”®å­—ï¼Œå­˜å‚¨çš„æ˜¯å¯¹è±¡é”ï¼ˆMonitorï¼‰çš„æŒ‡é’ˆ,ä½†åªæœ‰åœ¨ä½¿ç”¨åŒæ­¥ä»£ç å—ï¼ˆå¦‚`synchronized(obj)`ï¼‰æ—¶æ‰ä¼šåˆ›å»ºé”è®°å½•ï¼Œæ™®é€šæ–¹æ³•ä¸ä¼šåŒ…å«æ­¤éƒ¨åˆ†
> - **æ“ä½œæ•°æ ˆç”¨äºå­˜å‚¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸­é—´è®¡ç®—ç»“æœ**ï¼ˆå¦‚ç®—æœ¯è¿ç®—ã€æ–¹æ³•å‚æ•°ä¼ é€’ç­‰ï¼‰ï¼Œæ–¹æ³•å‚æ•°å’Œå±€éƒ¨å˜é‡å­˜å‚¨åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­

##### 3.4.1.2. å¤šä¸ªçº¿ç¨‹


æ¯ä¸ªçº¿ç¨‹çš„ **æ ˆå¸§éƒ½æ˜¯ç‹¬ç«‹çš„**ï¼Œäº’ä¸å½±å“

```java
public class TestFrames {
    public static void main(String[] args) {
        Thread t1 = new Thread(){
            @Override
            public void run() {
                method1(20);
            }
        };
        t1.setName("t1");
        t1.start();
        method1(10);
    }

    private static void method1(int x) {
        int y = x + 1;
        Object m = method2();
        System.out.println(m);
    }

    private static Object method2() {
        Object n = new Object();
        return n;
    }
}
```

#### 3.4.2. çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰

å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç 

- çº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œï¼ˆè¢«åŠ¨ï¼‰
- åƒåœ¾å›æ”¶ï¼ˆè¢«åŠ¨ï¼‰
- æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œï¼ˆè¢«åŠ¨ï¼‰
- çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lock ç­‰æ–¹æ³•ï¼ˆä¸»åŠ¨ï¼‰

å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ **ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰**ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯**çº¿ç¨‹ç§æœ‰**çš„

- çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰
- Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½

### 3.5. å¸¸è§æ–¹æ³•

1. **start()**ï¼šå¯åŠ¨çº¿ç¨‹ï¼Œè°ƒç”¨ run æ–¹æ³•
2. **run()**ï¼šçº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ï¼Œåœ¨ start() æ–¹æ³•è°ƒç”¨ä¹‹åæ‰§è¡Œ
<!-- TODO -->

### 3.6. start ä¸ run

- ç›´æ¥è°ƒç”¨ run æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº† runï¼Œæ²¡æœ‰å¯åŠ¨æ–°çš„çº¿ç¨‹
- ä½¿ç”¨ start æ˜¯å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œ run ä¸­çš„ä»£ç 

```java
@Slf4j(topic = "c.TestStart")
public class TestStart {
    public static void main(String[] args) {
        Thread t1 = new Thread("t1") {
            @Override
            public void run() {
                log.debug(Thread.currentThread().getName());
                FileReader.read(Constants.MP4_FULL_PATH);
            }
        };

        t1.run();
        log.debug("do other things ...");
    }
}
```

è¿è¡Œè¯¥ä»£ç ï¼Œè™½ç„¶runæ–¹æ³•åœ¨çº¿ç¨‹`t1`ä¸­æ‰§è¡Œï¼Œä½†`t1`çº¿ç¨‹æ²¡æœ‰å¯åŠ¨ï¼Œæ‰€ä»¥è¾“å‡ºçš„æ—¥å¿—æ˜¯`main`çº¿ç¨‹ï¼Œå³ä¸»çº¿ç¨‹

å¦‚æœæŠŠ `t1.run()` æ”¹ä¸º `t1.start()`ï¼Œåˆ™è¾“å‡ºçš„æ—¥å¿—æ˜¯`t1`çº¿ç¨‹ï¼Œå³å¯åŠ¨äº†çº¿ç¨‹`t1`

start()æ–¹æ³•ä¸èƒ½è¢«å¤šæ¬¡è°ƒç”¨ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼šjava.lang.IllegalThreadStateException

### 3.7. sleep ä¸ yield

#### 3.7.1. sleep

* è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» `Running`  è¿›å…¥ `Timed Waiting` çŠ¶æ€ï¼ˆé˜»å¡ï¼‰
* å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ `interrupt` æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º  `InterruptedException`  
* ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ
* å»ºè®®ç”¨ `TimeUnit` çš„ sleep ä»£æ›¿ `Thread` çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§ï¼ˆæœ‰å•ä½ï¼‰
    * `TimeUnit.SECONDS.sleep(1)` == `Thread.sleep(1000)`

æ¡ˆä¾‹ï¼š

while(true) é€‚ç”¨äºéœ€è¦æŒç»­è¿è¡Œçš„åœºæ™¯ï¼Œä½†å¿…é¡»ç»“åˆ sleep æˆ–äº‹ä»¶æœºåˆ¶é˜²æ­¢ CPU è¿‡è½½
  - éœ€è¦æŒç»­ç›‘å¬å¤–éƒ¨äº‹ä»¶ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ã€ç½‘ç»œè¯·æ±‚ã€ç¡¬ä»¶ä¿¡å·ç­‰ï¼‰
  - æŒç»­å¤„ç†å®æ—¶æ•°æ®æµï¼ˆå¦‚ä¼ æ„Ÿå™¨æ•°æ®ã€æ—¥å¿—ç›‘æ§ï¼‰

```Java
while(true) {
    try {
        Thread.sleep(50);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}
```

- å¯ä»¥ç”¨ wait æˆ– æ¡ä»¶å˜é‡è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœ
- ä¸åŒçš„æ˜¯ï¼Œåä¸¤ç§éƒ½éœ€è¦åŠ é”ï¼Œå¹¶ä¸”éœ€è¦ç›¸åº”çš„å”¤é†’æ“ä½œï¼Œä¸€èˆ¬é€‚ç”¨äºè¦è¿›è¡ŒåŒæ­¥çš„åœºæ™¯
- sleep é€‚ç”¨äºæ— éœ€é”åŒæ­¥çš„åœºæ™¯

#### 3.7.2. yield

- è°ƒç”¨ yield ä¼šè®©å½“å‰çº¿ç¨‹ä» `Running` è¿›å…¥ `Runnable`  å°±ç»ªçŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶å®ƒçº¿ç¨‹
- å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆå¦‚æœæƒ³è®©å‡ºå»ï¼Œä½†æ˜¯æ²¡æœ‰å…¶ä»–çº¿ç¨‹éœ€è¦ï¼Œå¯èƒ½ä¼šè®©ä¸å‡ºå»ï¼‰

> ä»»åŠ¡è°ƒåº¦å™¨ä¼šè€ƒè™‘æŠŠä»»åŠ¡åˆ†ç»™çŠ¶æ€ä¸º `Runnable` çš„çº¿ç¨‹ï¼Œä½†ä¸ä¼šè€ƒè™‘çŠ¶æ€ä¸º `Timed Waiting` çš„çº¿ç¨‹

#### 3.7.3. çº¿ç¨‹ä¼˜å…ˆçº§

* çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒ **ä»…ä»…æ˜¯ä¸€ä¸ªæç¤º** ï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒ
* å¦‚æœ cpu æ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½† cpu é—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨

```java
@Slf4j(topic = "c.TestYield")
public class TestYield {
    public static void main(String[] args) {
        Runnable task1 = () -> {
            int count = 0;
            for (;;) {
                System.out.println("---->1 " + count++);
            }
        };
        Runnable task2 = () -> {
            int count = 0;
            for (;;) {
//                Thread.yield();
                System.out.println("              ---->2 " + count++);
            }
        };
        Thread t1 = new Thread(task1, "t1");
        Thread t2 = new Thread(task2, "t2");
        t1.setPriority(Thread.MIN_PRIORITY);
        t2.setPriority(Thread.MAX_PRIORITY);
        t1.start();
        t2.start();
    }
}
```

### 3.8. joinæ–¹æ³•

#### 3.8.1. ä¸ºä»€ä¹ˆéœ€è¦join

```Java
static int r = 0;
public static void main(String[] args) throws InterruptedException {
    test1();
}
private static void test1() throws InterruptedException {
    log.debug("å¼€å§‹");
    Thread t1 = new Thread(() -> {
        log.debug("å¼€å§‹");
        sleep(1);
        log.debug("ç»“æŸ");
        r = 10;
    });
    t1.start();
    //t1.join();
    log.debug("ç»“æœä¸º:{}", r);
    log.debug("ç»“æŸ");
}
```

è¯¥æ–¹æ³•æœ€åæ‰“å°çš„ç»“æœæ˜¯r=0ï¼Œå› ä¸ºä¸»çº¿ç¨‹å’Œt1çº¿ç¨‹æ˜¯å¹¶è¡Œçš„
ä¸»çº¿ç¨‹è·å–rçš„å€¼çš„æ—¶å€™ï¼Œt1çº¿ç¨‹è¿˜æ²¡æ‰§è¡Œå®Œï¼Œæ‰€ä»¥rè¿˜æ˜¯0

joinæ–¹æ³•å¯ä»¥è®©ä¸»çº¿ç¨‹ç­‰å¾…t1çº¿ç¨‹æ‰§è¡Œå®Œå†æ‰§è¡Œï¼Œæ‰€ä»¥ç»“æœå°±æ˜¯r=10

joinæ–¹æ³•åŠŸèƒ½æ˜¯è®©å½“å‰çº¿ç¨‹ç­‰å¾…æŒ‡å®šçš„çº¿ç¨‹æ‰§è¡Œå®Œå†ç»§ç»­æ‰§è¡Œ

åŠ å…¥`t1.join();`åï¼Œä¸»çº¿ç¨‹ä¼šç­‰å¾…t1çº¿ç¨‹æ‰§è¡Œå®Œå†æ‰§è¡Œï¼Œæ‰€ä»¥ç»“æœå°±æ˜¯r=10

#### 3.8.2. ğŸåº”ç”¨ï¼šåŒæ­¥

ä»è°ƒç”¨æ–¹è§’åº¦æ¥è®²ï¼ŒåŒæ­¥ï¼ˆéœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼‰ï¼Œå¼‚æ­¥ï¼ˆä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼‰

å½“éœ€è¦ç­‰å¾…å¤šä¸ªç»“æœæ—¶

```Java
private static void test2() throws InterruptedException {
    Thread t1 = new Thread(() -> {
        sleep(1);
        r1 = 10;
    });
    Thread t2 = new Thread(() -> {
        sleep(2);
        r2 = 20;
    });
    t1.start();
    t2.start();
    long start = System.currentTimeMillis();
    log.debug("join begin");
    t1.join();  //t2.join();ç¬¬äºŒç§é¢ å€’
    log.debug("t2 join end");
    t2.join();  //t1.join();
    log.debug("t1 join end");
    long end = System.currentTimeMillis();
    log.debug("r1: {} r2: {} cost: {}", r1, r2, end - start);
}
```

![alt text](../0.image/Javaå¹¶å‘ç¼–ç¨‹/image-2.png)

#### 3.8.3. æœ‰æ—¶æ•ˆçš„join

join(long millis)

```java
public static void test3() throws InterruptedException {
    Thread t1 = new Thread(() -> {
        sleep(2);
        r1 = 10;
    });

    long start = System.currentTimeMillis();
    t1.start();

    // çº¿ç¨‹æ‰§è¡Œç»“æŸä¼šå¯¼è‡´ join ç»“æŸ
    log.debug("join begin");
    t1.join(3000);
    long end = System.currentTimeMillis();
    log.debug("r1: {} r2: {} cost: {}", r1, r2, end - start);
}
```

* æ²¡ç­‰å¤Ÿæ—¶é—´ï¼Œå°±åˆ°ç‚¹ç»“æŸ
* ç­‰å¤Ÿæ—¶é—´ï¼Œå°±æå‰ç»“æŸ

### 3.9. interruptæ–¹æ³•

#### 3.9.1. æ‰“æ–­sleep()ã€wait()ã€join()çš„çº¿ç¨‹

**sleepã€waitã€join** æ–¹æ³•éƒ½æ˜¯ **é˜»å¡**çº¿ç¨‹ çš„æ–¹æ³•

è¢«ä¸­æ–­æ—¶ç›´æ¥æŠ›å‡º `InterruptedException`ï¼Œè‡ªåŠ¨æ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œçº¿ç¨‹æ¢å¤åˆ°å¯è¿è¡ŒçŠ¶æ€

ä¸­æ–­çŠ¶æ€ï¼ˆæ‰“æ–­æ ‡è®°`t1.isInterrupt()`ï¼‰ä¼šè¢«æ¸…é™¤ï¼Œ`t1.isInterrupt() = false`

`isInterrupt()` vs `interrupted()`

- `isInterrupt()` ä¸ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°
- `interrupted()` åˆ¤æ–­å®Œä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°

> `sleep()`ã€`wait()`ã€`join()` é€šå¸¸ç”¨äºä¸šåŠ¡é€»è¾‘ä¸­çš„è€—æ—¶æ“ä½œï¼Œéœ€è¦æ˜ç¡®çš„ç»ˆæ­¢ä¿¡å·
> è¿™äº›æ–¹æ³•çš„é˜»å¡æ˜¯ **åŸºäºçº¿ç¨‹è°ƒåº¦å™¨çš„åä½œå¼æŒ‚èµ·**ï¼Œè®¾è®¡ç›®æ ‡æ˜¯ç®€åŒ–å¼€å‘è€…çš„å¼‚å¸¸å¤„ç†ï¼š
> 
> - æŠ›å‡º `InterruptedException`ï¼š
>   å¼ºåˆ¶å¼€å‘è€…æ˜ç¡®å¤„ç†ä¸­æ–­é€»è¾‘ï¼ˆå¦‚æ•è·å¼‚å¸¸åé€€å‡ºå¾ªç¯æˆ–èµ„æºæ¸…ç†ï¼‰
> - è‡ªåŠ¨æ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼š
>   æŠ›å‡ºå¼‚å¸¸åï¼Œçº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¼šè¢«é‡ç½®ä¸º `false`ï¼Œé¿å…é‡å¤è§¦å‘å¼‚å¸¸

#### 3.9.2. æ‰“æ–­park()çº¿ç¨‹

`park()` æ–¹æ³•ä¼š **ç«‹å³è§£é™¤é˜»å¡**ï¼Œçº¿ç¨‹æ¢å¤è¿è¡Œï¼Œ**ç»§ç»­æ‰§è¡Œ `park()` ä¹‹åçš„ä»£ç **ï¼Œä¸” **ä¸æŠ›å‡ºä»»ä½•å¼‚å¸¸**ï¼Œä½†ä¼šä¿ç•™ä¸­æ–­çŠ¶æ€ï¼ˆçº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ `isInterrupted()` ä¸º `true`ï¼‰

æ³¨æ„ï¼å½“ `park` çº¿ç¨‹è¢«æ‰“æ–­æ‰“æ–­æ ‡è®°ä¸º `true` åï¼Œå°±æ— æ³•å†æ‰§è¡Œ `park` æ–¹æ³•äº†ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ `interrupted` æ–¹æ³•è¿”å›æ‰“æ–­æ ‡è®°åï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œæ¸…é™¤æ ‡è®°ä¸º `false` å `park` æ–¹æ³•å¯ä»¥ç»§ç»­ç”Ÿæ•ˆ

> ä½œä¸ºæ„å»ºé«˜çº§åŒæ­¥å·¥å…·ï¼ˆå¦‚ `ReentrantLock`ï¼‰çš„åŸºç¡€ï¼Œéœ€è¦æ›´é«˜çš„æ€§èƒ½å’Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶æƒ
> `LockSupport.park()` çš„å®šä½æ˜¯ åº•å±‚åŒæ­¥å·¥å…·ï¼Œè®¾è®¡ç›®æ ‡æ˜¯çµæ´»æ€§å’Œæ€§èƒ½ï¼š
> 
> - ä¸æŠ›å‡ºå¼‚å¸¸ï¼š
>   å…è®¸å¼€å‘è€…è‡ªè¡Œå†³å®šæ˜¯å¦æ£€æŸ¥ä¸­æ–­çŠ¶æ€ï¼Œé€‚ç”¨äºæ— é”ç®—æ³•æˆ–é«˜é¢‘è°ƒç”¨åœºæ™¯
> - ä¿ç•™ä¸­æ–­çŠ¶æ€ï¼š
>   ä¸­æ–­æ ‡å¿—ä½ä¿æŒä¸º `true`ï¼Œå¼€å‘è€…éœ€æ‰‹åŠ¨å¤„ç†ï¼ˆä¾‹å¦‚ç»“åˆå¾ªç¯æ£€æŸ¥ï¼‰


#### 3.9.3. æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹

æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹åœ¨æ‰§è¡Œäº†interruptæ–¹æ³•åï¼Œä¸ä¼šåœæ­¢è¿è¡Œï¼Œåªæœ‰ä¸­æ–­çŠ¶æ€ï¼ˆæ‰“æ–­æ ‡è®°`t1.isInterrupt()`ï¼‰ä¼šè¢«ä¿ç•™ï¼Œ`t1.isInterrupt() = true`ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ‰“æ–­æ ‡è®°æ‰§è¡Œå…¶ä»–é€»è¾‘

#### 3.9.4. ğŸ›©ï¸æ¨¡å¼ï¼šä¸¤é˜¶æ®µç»ˆæ­¢

**Two Phase Termination**

åœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚

âŒä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹

- stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œ
å…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”

âŒä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹

- ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢

âœ…ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼

![alt text](../0.image/Javaå¹¶å‘ç¼–ç¨‹/image-3.png)

```java
class TPTInterrupt {
    private Thread thread;

    //å¯åŠ¨ç›‘æ§çº¿ç¨‹
    public void start(){
        thread = new Thread(() -> {
            while(true) {
                Thread current = Thread.currentThread();
                if(current.isInterrupted()) {
                    log.debug("æ–™ç†åäº‹");
                    break;
                }
                try {
                    Thread.sleep(1000);
                    log.debug("æ‰§è¡Œç›‘æ§è®°å½•");
                } catch (InterruptedException e) {
                    //é‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°
                    current.interrupt();
                }
                // æ‰§è¡Œç›‘æ§æ“ä½œ               
            }
        },"ç›‘æ§çº¿ç¨‹");
        thread.start();
    }
    public void stop() {
        thread.interrupt();
    }
}
```

### 3.10. ä¸æ¨èçš„æ–¹æ³•

è¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”ï¼Œè§ [ä¸¤ç»ˆæ­¢æ¨¡å¼](#394-ï¸æ¨¡å¼ä¸¤é˜¶æ®µç»ˆæ­¢)

æ–¹æ³•å | static | åŠŸèƒ½è¯´æ˜
---------|----------|---------
`stop()` |âœ–ï¸ | åœæ­¢çº¿ç¨‹è¿è¡Œ
`suspend()` |âœ–ï¸ | æŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ
`resume()` |âœ–ï¸ | æ¢å¤çº¿ç¨‹è¿è¡Œ

`suspend()` å’Œ `resume()`æ˜¯ä¸€å¯¹

### 3.11. ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJava è¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚
æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åš **å®ˆæŠ¤çº¿ç¨‹**ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚

`setDaemon(boolean)`æ–¹æ³•

* åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹
* Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚